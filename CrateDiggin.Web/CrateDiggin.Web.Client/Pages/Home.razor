@page "/"
@using CrateDiggin.Web.Client.Component
@using CrateDiggin.Web.Client.Clients
@using CrateDiggin.Web.Client.Models
@inject DigginApiClient ApiClient

<PageTitle>Crate Diggin'</PageTitle>

<div class="container mt-5">
    <div class="text-center mb-5">
        <h1 class="display-3 fw-bold">🎵 Crate Diggin'</h1>
        <p class="lead text-muted">Discover music by vibe, not just genre.</p>
    </div>

    <div class="row justify-content-center mb-5">
        <div class="col-md-8">
            <div class="input-group input-group-lg shadow-sm">
                <input type="text"
                       class="form-control"
                       placeholder="Describe your vibe... (e.g., 'smooth jazz for a rainy day')"
                       @bind="_query"
                       @bind:event="oninput"
                       @onkeyup="HandleKeyUp"
                       disabled="@_isSearching" />
                <button class="btn btn-primary px-4" @onclick="Search" disabled="@(_isSearching || string.IsNullOrWhiteSpace(_query))">
                    @if (_isSearching)
                    {
                        <span>Digging...</span>
                    }
                    else
                    {
                        <span>🔍 Dig</span>
                    }
                </button>
            </div>
        </div>
    </div>

    @if (_isSearching || _isRevealing)
    {
        <div class="row justify-content-center my-5">
            <div class="col-auto">
                <CrateAnimation IsSearching="@_isSearching" IsRevealing="@_isRevealing" />
            </div>
        </div>
    }

    @if (_albums != null && _albums.Any() && !_isSearching && !_isRevealing)
    {
        <div class="row">
            @foreach (var album in _albums)
            {
                <div class="col-sm-6 col-md-4 col-lg-3 mb-5">
                    <AlbumCard Album="album" />
                </div>
            }
        </div>
    }
    else if (_hasSearched && !_isSearching && !_isRevealing && (_albums == null || !_albums.Any()))
    {
        <div class="text-center mt-5 text-muted">
            <h3>🚫 No gems found.</h3>
            <p>Try a different description!</p>
        </div>
    }
</div>

@code {
    private string _query = "";
    private bool _isSearching = false;
    private bool _isRevealing = false;
    private bool _hasSearched = false;
    private List<Album> _albums = new();

    private async Task HandleKeyUp(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(_query))
        {
            await Search();
        }
    }

    private async Task Search()
    {
        if (string.IsNullOrWhiteSpace(_query) || _isSearching) return;

        _isSearching = true;
        _isRevealing = false;
        _albums.Clear();
        _hasSearched = true;

        // Trigger UI to show "Digging..."
        StateHasChanged();

        try
        {
            // 1. Start the API Search
            var searchTask = ApiClient.SearchAsync(_query);

            // 2. Play animation for at least 2 seconds (so it feels like digging)
            var animationTask = Task.Delay(2000);

            // 3. Wait for both to finish
            await Task.WhenAll(searchTask, animationTask);

            _albums = await searchTask;

            // 4. Reveal Phase (Optional: if CrateAnimation has a reveal state)
            _isSearching = false;
            _isRevealing = true;
            StateHasChanged();

            // 5. Short pause to let the "Reveal" animation play before showing the grid
            await Task.Delay(1000);
            _isRevealing = false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Search error: {ex.Message}");
            _isSearching = false;
            _isRevealing = false;
        }

        StateHasChanged();
    }
}